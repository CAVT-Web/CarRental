<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>📋 صفحة الحجوزات</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Segoe UI'; direction: rtl; background-color: #fafafa; padding: 20px; }

    #navbar {
      background:#007bff; padding:10px; color:white;
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:20px;
    }
    #navbar a { color:white; margin-right:15px; text-decoration:none; }
    #navbar a:hover { text-decoration: underline; }
    #navbar div:last-child { font-weight:bold; }

    .search-box { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    input, button { padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 5px; }
    button { cursor: pointer; background-color: #007bff; color: white; font-weight: bold; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #007bff; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }

    .edit-btn, .delete-btn { background-color: gray; color:white; border:none; padding:5px 10px; border-radius:5px; margin: 2px; }
  </style>
</head>
<body>

  <!-- شريط التنقل -->
  <div id="navbar">
    <div>
      <a href="index.html">🚗 الحجز</a>
      <a href="dashboard.html">📋 الحجوزات</a>
      <a href="settings.html">⚙️ الإعدادات</a>
    </div>
    <div>
      👤 مرحبًا، <span id="usernameDisplay"></span>
      <a href="#" onclick="logout()" style="color:#ffdddd; margin-right:15px;">🚪 خروج</a>
    </div>
  </div>

  <h2>📋 الحجوزات الحالية</h2>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="🔎 بحث بالاسم أو السيارة أو الموقع">
    <input type="date" id="dateFilter">
    <button onclick="exportToCSV()">📤 تصدير CSV</button>
    <button onclick="exportToPDF()">📄 تصدير PDF</button>
  </div>

  <div id="bookingCount"></div>

  <table id="bookingsTable">
    <thead>
      <tr>
        <th>الاسم</th>
        <th>الهاتف</th>
        <th>السيارة</th>
        <th>من</th>
        <th>إلى</th>
        <th>الموقع</th>
        <th>عدد الأيام</th>
        <th>السعر</th>
        <th>التحكم</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // رابط Google Sheets Script
    const API_URL = "https://script.google.com/macros/s/AKfycbyxeV9U9uYZZZ13kWy6121Sz_0KhAsTFrvcmk-3zpwHrMf2rmjnnWlumM5oN1GjApfJ4g/exec";

    // حماية الصفحة
    if (localStorage.getItem("isLoggedIn") !== "true") {
      alert("🔐 يرجى تسجيل الدخول أولاً");
      window.location.href = "login.html";
    }

    const username = localStorage.getItem("loggedUser") || "مستخدم";
    document.getElementById("usernameDisplay").textContent = username;

    function logout() {
      localStorage.removeItem("isLoggedIn");
      localStorage.removeItem("loggedUser");
      window.location.href = "login.html";
    }

    const tbody = document.querySelector("#bookingsTable tbody");
    const searchInput = document.getElementById("searchInput");
    const dateFilter = document.getElementById("dateFilter");
    const bookingCount = document.getElementById("bookingCount");
    let bookings = [];

    async function fetchBookings() {
      try {
        const response = await fetch(API_URL);
        bookings = await response.json();
        renderTable(bookings);
      } catch (err) {
        alert("حدث خطأ أثناء تحميل البيانات. تأكد من صحة الرابط.");
      }
    }

    function renderTable(data) {
      tbody.innerHTML = "";
      data.forEach((booking) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${booking.name}</td>
          <td>${booking.phone}</td>
          <td>${booking.car}</td>
          <td>${booking.start}</td>
          <td>${booking.end}</td>
          <td>${booking.location}</td>
          <td>${booking.duration}</td>
          <td>${booking.total}</td>
          <td><span style="color:gray">غير متاح</span></td>
        `;
        tbody.appendChild(tr);
      });
      bookingCount.textContent = `🔢 عدد الحجوزات: ${data.length}`;
    }

    function filterBookings() {
      const keyword = searchInput.value.toLowerCase();
      const filterDate = dateFilter.value;
      const filtered = bookings.filter(b => {
        const matchesKeyword = b.name.toLowerCase().includes(keyword) || 
                               b.car.toLowerCase().includes(keyword) || 
                               b.location.toLowerCase().includes(keyword);
        const matchesDate = filterDate ? b.start === filterDate || b.end === filterDate : true;
        return matchesKeyword && matchesDate;
      });
      renderTable(filtered);
    }

    function exportToCSV() {
      const csvRows = [["الاسم", "الهاتف", "السيارة", "من", "إلى", "الموقع", "عدد الأيام", "السعر"]];
      bookings.forEach(b => {
        csvRows.push([b.name, b.phone, b.car, b.start, b.end, b.location, b.duration, b.total]);
      });
      const csvContent = csvRows.map(row => row.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "الحجوزات.csv";
      link.click();
    }

    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

      doc.setFontSize(16);
      doc.text("📋 قائمة الحجوزات", 40, 40);

      const headers = [["الاسم", "الهاتف", "السيارة", "من", "إلى", "الموقع", "عدد الأيام", "السعر"]];
      const dataRows = bookings.map(b => [
        b.name, b.phone, b.car, b.start, b.end,
        b.location,
        b.duration,
        b.total
      ]);

      const allRows = headers.concat(dataRows);
      let y = 70;
      allRows.forEach((row, i) => {
        let x = 40;
        row.forEach(cell => {
          doc.text(String(cell), x, y);
          x += 100;
        });
        y += 25;
        if (y > 550) {
          doc.addPage();
          y = 40;
        }
      });

      doc.save("الحجوزات.pdf");
    }

    searchInput.addEventListener("input", filterBookings);
    dateFilter.addEventListener("change", filterBookings);
    window.onload = fetchBookings;
  </script>
</body>
</html>
